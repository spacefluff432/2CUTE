"use strict";var __awaiter=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(r,o){function a(t){try{h(i.next(t))}catch(t){o(t)}}function n(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,n)}h((i=i.apply(t,e||[])).next())}))};const XCore={storage:new Set,add(t){XCore.storage.add(t)},ready(t){Promise.all(XCore.storage).then(t)}};class XEntity{constructor({attributes:{backdrop:t=!1,collide:e=!1,interact:s=!1,trigger:i=!1,see:r=!1}={backdrop:!1,collide:!1,interact:!1,trigger:!1,see:!1},bounds:{h:o=0,w:a=0,x:n=0,y:h=0}={},depth:c=0,metadata:d={},position:{x:l=0,y:p=0}={},sprite:u}={}){this.attributes={backdrop:t,collide:e,interact:s,trigger:i,see:r},this.bounds={h:o,w:a,x:n,y:h},this.depth=c,this.metadata=d,this.position={x:l,y:p},this.sprite=u}}class XHost{constructor(){this.events=new Map}on(t,e){this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e)}off(t,e){this.events.has(t)&&this.events.get(t).delete(e)}fire(t,...e){return this.events.has(t)?[...this.events.get(t)].sort(((t,e)=>("function"==typeof t?0:t.priority)-("function"==typeof e?0:e.priority))).map((t=>("function"==typeof t?t:t.script)(...e))):[]}}class XRenderer{constructor({canvas:t=document.createElement("canvas"),size:{x:e=1e3,y:s=1e3}={}}={}){this.state={scale:1},this.canvas=t,this.size={x:e,y:s},this.refresh()}refresh(){this.context=this.canvas.getContext("2d"),this.context.imageSmoothingEnabled=!1}render(t,...e){this.context.resetTransform(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.setTransform(this.state.scale,0,0,this.state.scale,(-1*t.x+this.size.x/2)*this.state.scale,(t.y+this.size.y/2)*this.state.scale);for(const t of e.sort(((t,e)=>t.depth-e.depth)))if(t.sprite){const e=t.sprite.compute();if(e){const s=isFinite(e.bounds.w)?e.bounds.w:e.image.width,i=isFinite(e.bounds.h)?e.bounds.h:e.image.height;this.context.drawImage(e.image,e.bounds.x,e.bounds.y,s,i,t.position.x,-1*t.position.y-i,s,i)}}}rescale(t=this.canvas.height,e=this.canvas.width){const s=this.size.x/this.size.y;e/t>s?(this.canvas.width=t*s,this.canvas.height=t,this.state.scale=t/this.size.y):(this.canvas.width=e,this.canvas.height=e/s,this.state.scale=e/this.size.x)}update(t,e){this.rescale(t,e),this.refresh()}}class XSound{constructor({source:t="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA="}={}){this.audio=XSound.audio(t)}static audio(t){const e=XSound.cache.get(t)||new Audio(t);return XSound.cache.has(t)||(XSound.cache.set(t,e),XCore.add(new Promise(((t,s)=>{e.addEventListener("load",(()=>{t()})),e.addEventListener("error",(()=>{s()}))})))),e}}XSound.cache=new Map;class XSprite{constructor({attributes:{persist:t=!1,hold:e=!1}={persist:!1,hold:!1},default:s=0,rotation:i=0,scale:r=1,state:{active:o=!1,index:a=0,step:n=0}={active:!1,index:0,step:0},steps:h=1,textures:c=[]}={}){this.attributes={persist:t,hold:e},this.default=s,this.rotation=i,this.scale=r,this.state={active:o,index:a,step:n},this.steps=h,this.textures=[...c]}compute(){if(this.state.active||this.attributes.persist){const t=this.textures[this.state.index];return this.state.active&&++this.state.step>=this.steps&&(this.state.step=0,++this.state.index>=this.textures.length&&(this.state.index=0)),t}}disable(){this.state.active&&(this.attributes.hold||(this.state.step=0,this.state.index=this.default),this.state.active=!1)}enable(){this.state.active||(this.attributes.hold||(this.state.step=0,this.state.index=this.default),this.state.active=!0)}}class XSet{constructor(...t){this.state=new Set(t)}get collection(){return new Set([...this.state].map((t=>[...t])).flat())}get size(){return this.collection.size}add(t){throw new ReferenceError("This XSet has no defined adder!")}clear(){for(const t of this.state)t.clear()}delete(t){throw new ReferenceError("This XSet has no defined deleter!")}forEach(t,e){return this.collection.forEach(t,e)}has(t){return this.collection.has(t)}entries(){return this.collection.entries()}keys(){return this.collection.keys()}values(){return this.collection.values()}[Symbol.iterator](){return this.collection[Symbol.iterator]()}}Symbol.toStringTag;class XRoom extends XSet{constructor({bounds:{h:t=0,w:e=0,x:s=0,y:i=0}={},entities:r=[],player:o=new XEntity}={}){super(),this.backdrops=new Set,this.collides=new Set,this.interacts=new Set,this.triggers=new Set,this.sees=new Set,this.state=new Set([this.backdrops,this.collides,this.interacts,this.triggers,this.sees]),this.bounds={h:t,w:e,x:s,y:i},this.player=o;for(const t of r)this.add(t)}add(t){return t.attributes.backdrop&&this.backdrops.add(t),t.attributes.collide&&this.collides.add(t),t.attributes.interact&&this.interacts.add(t),t.attributes.trigger&&this.triggers.add(t),t.attributes.backdrop||t.attributes.see&&this.sees.add(t),this}delete(t){let e=!0;return t.attributes.backdrop&&(this.backdrops.delete(t)||(e=!1)),t.attributes.collide&&(this.collides.delete(t)||(e=!1)),t.attributes.interact&&(this.interacts.delete(t)||(e=!1)),t.attributes.trigger&&(this.triggers.delete(t)||(e=!1)),t.attributes.backdrop||t.attributes.see&&(this.sees.delete(t)||(e=!1)),e}}class XTexture{constructor({bounds:{h:t=1/0,w:e=1/0,x:s=0,y:i=0}={},source:r="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="}={}){this.bounds={h:t,w:e,x:s,y:i},this.image=XTexture.image(r)}static image(t){const e=XTexture.cache.get(t)||Object.assign(new Image,{src:t});return XTexture.cache.has(t)||(XTexture.cache.set(t,e),XCore.add(new Promise(((t,s)=>{e.addEventListener("load",(()=>{t()})),e.addEventListener("error",(()=>{s()}))})))),e}}XTexture.cache=new Map;class XKey extends XHost{constructor(...t){super(),this.states=new Set,this.keys=new Set(t),addEventListener("keydown",(t=>{this.keys.has(t.key)&&!this.states.has(t.key)&&(this.states.add(t.key),this.fire("down"))})),addEventListener("keyup",(t=>{this.keys.has(t.key)&&this.states.has(t.key)&&(this.states.delete(t.key),this.fire("up"))})),addEventListener("keypress",(t=>{this.keys.has(t.key)&&this.fire("press")}))}get active(){return this.states.size>0}}class XOverworld extends XHost{constructor({background:t=new XRenderer,foreground:e=new XRenderer,keys:{u:s=new XKey,l:i=new XKey,d:r=new XKey,r:o=new XKey,z:a=new XKey,x:n=new XKey,c:h=new XKey}={},room:c=new XRoom,speed:d=1,sprites:{u:l=new XSprite,l:p=new XSprite,d:u=new XSprite,r:y=new XSprite}={},state:{detect:m=!0,interact:f=!0,move:b=!0}={}}={}){super(),this.background=t,this.foreground=e,this.keys={u:s,l:i,d:r,r:o,z:a,x:n,c:h},this.room=c,this.speed=d,this.sprites={u:l,l:p,d:u,r:y},this.state={detect:m,interact:f,move:b},this.keys.u.on("up",(()=>this.state.move&&this.sprites.u.disable())),this.keys.l.on("up",(()=>this.state.move&&this.sprites.l.disable())),this.keys.d.on("up",(()=>this.state.move&&this.sprites.d.disable())),this.keys.r.on("up",(()=>this.state.move&&this.sprites.r.disable())),this.keys.u.on("down",(()=>this.state.move&&this.sprites.u.enable())),this.keys.l.on("down",(()=>this.state.move&&this.sprites.l.enable())),this.keys.d.on("down",(()=>this.state.move&&this.sprites.d.enable())),this.keys.r.on("down",(()=>this.state.move&&this.sprites.r.enable())),this.keys.z.on("down",(()=>{if(this.interact)for(const t of XWorld.intersection(XWorld.bounds(this.room.player),...this.room.interacts))this.fire("interact",t)})),this.refresh()}get detect(){return this.state.detect}set detect(t){this.state.detect=t}get interact(){return this.state.interact}set interact(t){this.state.interact=t}get move(){return this.state.move}set move(t){this.state.move=t,this.state.move?(this.keys.u.active&&this.sprites.u.enable(),this.keys.l.active&&this.sprites.l.enable(),this.keys.d.active&&this.sprites.d.enable(),this.keys.r.active&&this.sprites.r.enable()):(this.sprites.u.disable(),this.sprites.l.disable(),this.sprites.d.disable(),this.sprites.r.disable())}refresh(){this.background.refresh(),this.foreground.refresh(),XCore.ready((()=>{this.background.render(XWorld.center(this.room.player),this.room.player,...this.room.backdrops)}))}render(){const t=new Set,e=Object.assign({},this.room.player.position);if(this.move){const s={u:this.keys.u.active,l:this.keys.l.active,d:this.keys.d.active,r:this.keys.r.active};if(s.l||s.r){this.room.player.position.x-=s.l?this.speed:-this.speed;const i=XWorld.intersection(XWorld.bounds(this.room.player),...this.room.collides);if(i.size>0){this.room.player.position=Object.assign({},e);let r=0,o=!1;for(;!o&&++r<this.speed;)this.room.player.position.x-=s.l?1:-1,o=XWorld.intersection(XWorld.bounds(this.room.player),...i).size>0;o&&(this.room.player.position.x+=s.l?1:-1);for(const e of i)t.add(e)}}if(s.u||s.d){const e=Object.assign({},this.room.player.position);this.room.player.position.y+=s.u?this.speed:-this.speed;const i=XWorld.intersection(XWorld.bounds(this.room.player),...this.room.collides);if(i.size>0){this.room.player.position=Object.assign({},e);let r=0,o=!1;for(;!o&&++r<this.speed;)this.room.player.position.y+=s.u?1:-1,o=XWorld.intersection(XWorld.bounds(this.room.player),...i).size>0;o&&(this.room.player.position.y-=s.u?1:-1),o&&1===r&&s.u&&s.d&&this.room.player.position.y--;for(const e of i)t.add(e)}}this.room.player.position.x<e.x?(this.room.player.sprite=this.sprites.l,this.sprites.l.enable()):this.room.player.position.x>e.x?(this.room.player.sprite=this.sprites.r,this.sprites.r.enable()):(this.sprites.l.disable(),this.sprites.r.disable()),this.room.player.position.y>e.y?(this.room.player.sprite=this.sprites.u,this.sprites.u.enable()):this.room.player.position.y<e.y?(this.room.player.sprite=this.sprites.d,this.sprites.d.enable()):(this.sprites.u.disable(),this.sprites.d.disable()),this.room.player.position.x===e.x&&this.room.player.position.y===e.y||this.background.render(XWorld.center(this.room.player),this.room.player,...this.room.backdrops)}if(this.foreground.render(XWorld.center(this.room.player),this.room.player,...this.room.sees),this.move)for(const e of t)this.fire("collide",e);if(this.detect)for(const t of XWorld.intersection(XWorld.bounds(this.room.player),...this.room.triggers))this.fire("trigger",t)}rescale(t,e){this.background.rescale(t,e),this.foreground.rescale(t,e)}update(t,e){this.rescale(t,e),this.refresh()}}const XWorld={bounds:t=>({x:t.position.x+t.bounds.x+Math.min(t.bounds.w,0),y:t.position.y+t.bounds.y+Math.min(t.bounds.h,0),w:Math.abs(t.bounds.w),h:Math.abs(t.bounds.h)}),center(t){if(t.sprite){const e=t.sprite.textures[t.sprite.state.index].image;return{x:t.position.x+e.width/2,y:t.position.y+e.height/2}}return t.position},intersection({x:t=0,y:e=0,h:s=0,w:i=0},...r){const o=new Set;for(const a of r){const r=XWorld.bounds(a);t<r.x+r.w&&t+i>r.x&&e<r.y+r.h&&e+s>r.y&&o.add(a)}return o}};class XDialogue extends XHost{constructor({advance:t=new XKey,menu:e=new XMenu,interval:s=0,reader:i=new XReader,speakers:r={},skip:o=new XKey,state:{active:a=!1,speaker:n="default",text:h=""}={}}={}){super(),this.advance=t,this.menu=e,this.interval=s,this.reader=i,this.speakers=r,this.skip=o,this.state={active:a,speaker:n,text:h},this.reader.on("idle",(()=>{const t=this.speaker;t&&t.sprite.disable()})),this.reader.on("read",(()=>{const t=this.speaker;t&&t.sprite.enable(),this.state.text="",this.state.active||(this.state.active=!0,this.menu.style.opacity="1",this.fire("enable"));let e=!1,s=this.interval;return{char:t=>__awaiter(this,void 0,void 0,(function*(){yield Promise.race([new Promise((t=>{setTimeout((()=>t(0)),s),s===this.interval||(s=this.interval)})),new Promise((t=>{if(e)t(0);else{const s=()=>{e=!0,t(0),this.skip.off("down",s)};this.skip.on("down",s)}}))]),this.state.text+=t})),code:t=>__awaiter(this,void 0,void 0,(function*(){switch(t[0]){case"^":s=Number(t[1])*(2*this.interval);break;case"!":switch(t.slice(1)){case"advance":this.reader.advance()}}}))}})),this.reader.on("empty",(()=>{this.state.text="",this.state.active&&(this.state.active=!1,this.menu.style.opacity="0",this.fire("disable"))})),this.reader.on("style",(([t,e])=>{switch(t){case"speaker":this.state.speaker=e;break;case"voice":this.speaker.state.voice=e;break;case"sprite":this.speaker.state.sprite=e}})),this.advance.on("down",(()=>this.state.active&&this.reader.advance()))}get speaker(){return this.speakers[this.state.speaker]}computeImage(){const t=this.speaker;if(t){const e=t.sprite.compute();if(e)return e.image}}computeText(){return this.state.text}}class XItem{constructor({content:t=(()=>{}),element:e=document.createElement("x"),style:{content:s={},item:i={}}={}}={}){this.content=t,this.element=e,this.style={content:s,item:i}}tick(){Object.assign(this.element.style,this.style.item);const t=this.element.firstElementChild,e=this.content();e?(Object.assign(e.style,this.style.content),t&&(t===e||t.remove()),this.element.firstElementChild||this.element.appendChild(e)):t&&t.remove()}}class XMenu{constructor({element:t=document.createElement("x"),items:e={},style:s={}}={}){this.element=t,this.items=e,this.style=s}tick(){Object.assign(this.element.style,this.style);const t=new Set;this.element.childNodes.forEach((e=>t.add(e)));const e=new Set;for(const t in this.items){const s=this.items[t];s.tick(),e.add(s.element)}for(const s of t)e.has(s)||t.has(s)&&this.element.removeChild(s);for(const s of e)t.has(s)||this.element.appendChild(s)}}class XReader extends XHost{constructor(){super(...arguments),this.lines=[],this.state={mode:"empty",text:"",skip:!1}}add(...t){const e=t.join("\n").split("\n").map((t=>t.trim())).filter((t=>t.length>0));e.length>0&&(this.lines.push(...e),"empty"===this.state.mode&&(this.state.mode="idle",this.read()))}advance(){this.lines.splice(0,1),this.read()}parse(t){if(t.startsWith("[")&&t.endsWith("]")){const e=new Map;for(const s of t.slice(1,-1).split("|"))if(s.includes(":")){const[t,i]=s.split(":").slice(0,2);e.set(t,i)}else e.set(s,"true");return e}return t}read(){return __awaiter(this,void 0,void 0,(function*(){if("idle"===this.state.mode)if(this.lines.length>0){const t=this.parse(this.lines[0]);if("string"==typeof t){this.state.mode="read";for(const{code:e,char:s}of this.fire("read")){let i=0;for(;i<t.length;){const r=t[i++];if("{"===r){const s=t.slice(i,t.indexOf("}",i));i=i+s.length+1,yield e(s)}else yield s(r)}}this.state.mode="idle",this.fire("idle")}else{for(const e of t)this.fire("style",e);this.advance()}}else this.state.mode="empty",this.fire("empty")}))}}class XSpeaker{constructor({sprites:t={},state:{sprite:e="default",voice:s="default"}={},voices:i={}}={}){this.sprites=t,this.state={sprite:e,voice:s},this.voices=i}get sprite(){return this.sprites[this.state.sprite]}}